<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CAN lower layer | ThingSet Protocol Specification</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="apple-touch-icon" sizes="180x180" href="/thingset/branch/quickfix-example-4/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/thingset/branch/quickfix-example-4/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/thingset/branch/quickfix-example-4/favicons/favicon-16x16.png">
    <link rel="manifest" href="/thingset/branch/quickfix-example-4/favicons/site.webmanifest">
    <link rel="mask-icon" href="/thingset/branch/quickfix-example-4/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/thingset/branch/quickfix-example-4/favicons/favicon.ico">
    <meta name="description" content="The ThingSet protocol provides a consistent, standardized way to configure, monitor and control ressource-constrained devices via different communication interfaces like Serial, LoRa, USB, Bluetooth or CAN.">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/thingset/branch/quickfix-example-4/assets/css/0.styles.b182d6b0.css" as="style"><link rel="preload" href="/thingset/branch/quickfix-example-4/assets/js/app.e82a7297.js" as="script"><link rel="preload" href="/thingset/branch/quickfix-example-4/assets/js/2.f8dcb625.js" as="script"><link rel="preload" href="/thingset/branch/quickfix-example-4/assets/js/3.37d47788.js" as="script"><link rel="preload" href="/thingset/branch/quickfix-example-4/assets/js/4.6408cc72.js" as="script"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/10.bec7f89e.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/11.4eeabb36.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/12.df21bce6.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/13.c183f414.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/14.b52ab5a7.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/15.2f0b203a.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/16.3e711864.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/17.e7f4c269.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/18.f7132805.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/19.282eb6e5.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/20.fde02dae.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/21.0f4c9a5d.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/22.f407caf7.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/23.ef381cff.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/24.06bf6126.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/25.bfe5c9a8.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/26.9153cb6a.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/27.be77b6b6.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/28.9be914e5.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/29.9e7fa9c1.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/5.3e012dac.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/6.63efe20a.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/7.e9fa7449.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/8.3ff5aa83.js"><link rel="prefetch" href="/thingset/branch/quickfix-example-4/assets/js/9.ac70af2f.js">
    <link rel="stylesheet" href="/thingset/branch/quickfix-example-4/assets/css/0.styles.b182d6b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/thingset/branch/quickfix-example-4/" class="home-link router-link-active"><img src="/thingset/branch/quickfix-example-4/favicons/apple-touch-icon.png" alt="ThingSet Protocol Specification" class="logo"> <span class="site-name">ThingSet Protocol Specification</span></a> <div class="links"><div class="search-box can-hide"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="History Menu" class="dropdown-title"><span class="title">History</span> <span class="arrow down"></span></button> <button type="button" aria-label="History Menu" class="mobile-dropdown-title"><span class="title">History</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/thingset/branch/quickfix-example-4/" class="nav-link">
  v0.3
</a></li><li class="dropdown-item"><!----> <a href="/thingset/branch/quickfix-example-4/v0.2/" class="nav-link">
  v0.2
</a></li><li class="dropdown-item"><!----> <a href="/thingset/branch/quickfix-example-4/v0.1/" class="nav-link router-link-active">
  v0.1
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="History Menu" class="dropdown-title"><span class="title">History</span> <span class="arrow down"></span></button> <button type="button" aria-label="History Menu" class="mobile-dropdown-title"><span class="title">History</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/thingset/branch/quickfix-example-4/" class="nav-link">
  v0.3
</a></li><li class="dropdown-item"><!----> <a href="/thingset/branch/quickfix-example-4/v0.2/" class="nav-link">
  v0.2
</a></li><li class="dropdown-item"><!----> <a href="/thingset/branch/quickfix-example-4/v0.1/" class="nav-link router-link-active">
  v0.1
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Why ThingSet?</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thingset/branch/quickfix-example-4/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/thingset/branch/quickfix-example-4/1b_existing_solutions.html" class="sidebar-link">Existing Standards</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Application Layer</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thingset/branch/quickfix-example-4/2a_general.html" class="sidebar-link">General Concept</a></li><li><a href="/thingset/branch/quickfix-example-4/2b_text_mode.html" class="sidebar-link">Text Mode</a></li><li><a href="/thingset/branch/quickfix-example-4/2c_binary_mode.html" class="sidebar-link">Binary Mode</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Lower Layers</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thingset/branch/quickfix-example-4/3a_serial.html" class="sidebar-link">Serial</a></li><li><a href="/thingset/branch/quickfix-example-4/3b_can.html" class="sidebar-link">CAN</a></li><li><a href="/thingset/branch/quickfix-example-4/3c_lora.html" class="sidebar-link">LoRa</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Protocol Mapping</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thingset/branch/quickfix-example-4/4a_http.html" class="sidebar-link">HTTP</a></li><li><a href="/thingset/branch/quickfix-example-4/4b_coap.html" class="sidebar-link">CoAP</a></li><li><a href="/thingset/branch/quickfix-example-4/4c_mqtt.html" class="sidebar-link">MQTT</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="can-lower-layer"><a href="#can-lower-layer" class="header-anchor">#</a> CAN lower layer</h1> <p>This specification defines layer 3 (Network) and 4 (Transport) of the ThingSet Protocol via CAN bus. Layer 1 and 2 are provided by the CAN bus itself.</p> <p>Only the binary messages of the ThingSet Protocol are supported via CAN.</p> <h2 id="general-features"><a href="#general-features" class="header-anchor">#</a> General features</h2> <ul><li><p>Master-less operation</p></li> <li><p>Automatic node ID assignment</p></li> <li><p>Efficient useage of CAN ID and data bytes</p></li> <li><p>Transport protocol to allow payload of more than 8 bytes</p></li> <li><p>Two different types of messages for application layer</p> <ul><li>Service message (request/response)</li> <li>Data object publication message (publish/subscribe)</li></ul></li> <li><p>RTR frame is not allowed</p></li> <li><p>Fixed bitrate of 250 kbit</p></li></ul> <h3 id="can-identifier-layout"><a href="#can-identifier-layout" class="header-anchor">#</a> CAN identifier layout</h3> <p>In the CAN bus, the identifier part of the CAN frame is used for arbitration and identification of the message type. Typically, it does not define the sender or receiver of the message, but the content of the message.</p> <p>For a network with connected ThingSet devices, the layout of the CAN identifier is similar to the SAE J1939 specification. Parts of the identifier define the source and destination address of the message. In addition to that, the first three bits are used to prioritize the messages.</p> <p>Two general types of messages are specified: Service message and Data object publication message. Only CAN extended ID with a size of 29 bit is used.</p> <h2 id="service-message"><a href="#service-message" class="header-anchor">#</a> Service message</h2> <p>A service message is used for the request/response communication model. A single byte each for source and destination node address are defined as part of the CAN ID to identify sender and receiver of the message. In addition to that, the function ID is specified as part of the CAN ID.</p> <h3 id="can-identifier-layout-2"><a href="#can-identifier-layout-2" class="header-anchor">#</a> CAN identifier layout</h3> <p>The service message CAN ID layout is shown in the following picture:</p> <p><img src="/thingset/branch/quickfix-example-4/assets/img/service_msg_can_id.57f19456.png" alt="CAN service message ID"></p> <ul><li>Priority (28-26): Defines the importance of the message. For service messages, only 3 (high priority) or 7 (low priority) are valid.</li> <li>Extended data page / EDP (25): Always 1b to prevent collision with SAE J1939 and NMEA2000 devices on the same bus</li> <li>Message type (24): 0b for service message</li> <li>Function ID (23-16): Function ID of application layer protocol</li> <li>Destination address (15-8): Destination node address (255 for broadcast)</li> <li>Source address (7-0): Source node address (255 for anonymous message during address claiming)</li></ul> <h3 id="transport-protocol-iso-15765-2"><a href="#transport-protocol-iso-15765-2" class="header-anchor">#</a> Transport protocol (ISO 15765-2)</h3> <p>In order to transfer data with a length of more than 8 bytes, the transfer protocol specified in <a href="https://en.wikipedia.org/wiki/ISO_15765-2" target="_blank" rel="noopener noreferrer">ISO 15765-2 (ISO-TP)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is used.</p> <p>It allows a maximum number of 4095 data bytes (defined by 12 bit unsigned int length code in first frame). Flow control mechanisms ensure the reliability of data reception.</p> <p>As a very important feature, ISO-TP allows the efficient transfer of single-frame messages with only one byte of overhead (and no flow control packets). This feature is necessary, as it is not known before if a certain function of the energy management protocol will transfer only a few bytes or a large amount of data.</p> <p>Unfortunately, the standard is not accessible for free. However, several open source implementations (including <a href="https://github.com/hartkopp/can-isotp" target="_blank" rel="noopener noreferrer">SocketCAN for Linux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) of the ISO-TP are available. Most important information about the frame layout can be found on <a href="https://en.wikipedia.org/wiki/ISO_15765-2" target="_blank" rel="noopener noreferrer">Wikipedia<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h4 id="single-frame-message-request-response"><a href="#single-frame-message-request-response" class="header-anchor">#</a> Single-frame message request/response</h4> <p>Application protocol data of 8 bytes or lower can be transferred using a single CAN frame. The function ID of the application protocol (byte 1) is already included in the CAN indentifier. The first byte of the CAN data contains the ISO-TP header for a single-frame message. Bytes 2 to n (with n &lt;= 8) are contained in the remaining data bytes of the CAN frame.</p> <table><thead><tr><th>Byte 1</th><th>Byte 2</th><th>...</th><th>Byte 8</th></tr></thead><tbody><tr><td>ISO-TP header</td> <td>Application protocol (byte 2)</td> <td>...</td> <td>Application protocol (byte 8)</td></tr></tbody></table> <h4 id="multi-frame-message-request-response"><a href="#multi-frame-message-request-response" class="header-anchor">#</a> Multi-frame message request/response</h4> <p>More than 8 bytes of application protocol data are sent as multi-frame messages.</p> <p>The first message contains two bytes for the ISO-TP header (including also the total message length). As the function ID (first byte of application protocol data) is already stored in the CAN identifier, the application protocol byte numbering starts with 2.</p> <table><thead><tr><th>Byte 1</th><th>Byte 2</th><th>Byte 3</th><th>...</th><th>Byte 8</th></tr></thead><tbody><tr><td colspan="2">ISO-TP header</td> <td>Application protocol (byte 2)</td> <td>...</td> <td>Application protocol (byte 7)</td></tr></tbody></table> <p>Consecutive messages i = 2...585 consume only one byte for the ISO-TP header:</p> <table><thead><tr><th>Byte 1</th><th>Byte 2</th><th>...</th><th>Byte 8</th></tr></thead><tbody><tr><td>ISO-TP header</td> <td>Application protocol (byte i\*7-6)</td> <td>...</td> <td>Application protocol (byte i\*7)</td></tr></tbody></table> <h3 id="remarks-regarding-existing-transport-protocols"><a href="#remarks-regarding-existing-transport-protocols" class="header-anchor">#</a> Remarks regarding existing transport protocols</h3> <p>Several other transport protocols for CAN have been defined in different standards.</p> <p>For the J1939 protocol, the transport protocol is specified in the standard <strong>SAE J1939-21</strong>. Two types of transport protocol are defined: The Connection Mode Data Transfer (CMDT) and the Broadcast Announce Message (BAM). CMDT is used to exchange data between two nodes. It includes methods for flow control and handshake. BAM is more simple and broadcasts a multi-packet message to the bus without feedback if the message was received.</p> <p>CMDT and BAM allow to transfer 9 to 1785 bytes (255 packets * 7 bytes) of payload. It is not allowed to transfer 0 to 8 bytes using the J1939 transport protocols. Thus, we need to know before if a message needs the mechanisms of the transport protocol or not. This is not possible for the flexible energy management protocol, as the same functions might transfer either very little data (e.g. write 16-bit integer) or a large amount of data (e.g. write a strings). Data with less than 9 bytes would have to be stuffed, making the protocol very inefficient. A message which could fit into a single CAN frame would need 5 frames (including flow control) when using CMDT and stuffing.</p> <p>The <strong>RV-C</strong> standard defines a different transport protocol than SAE J1939, which also allows the transfer of up to 1785 bytes. However, is does not specify any flow control mechanisms at all. So it is not possible to determine if a message was received even for a communication between only two nodes, which is not acceptable.</p> <p>NMEA 2000 uses the same transport protocol as the SAE J1939 protocol. In addition to that, it defines a so-called fast packet protocol. With <strong>NMEA 2000 fast packet protocol</strong>, 223 bytes can be transferred without flow control, thus, making it more efficient and &quot;fast&quot;.</p> <p>With the fast packet protocol, a single frame transfer is possible. However, a single frame message consumes 2 out of 8 bytes for the fast packet header information. This is considered too high overhead if it is unknown whether a single or multi-frame message has to be used. The Tiny-TP (see below) for the data object publication messages is based on the NMEA 2000 fast packet protocol, but reduces its overhead for single frame messages.</p> <p>Overview of different CAN based transport protocols:</p> <table><thead><tr><th></th> <th style="text-align:center;">ISO-TP</th> <th style="text-align:center;">NMEA 2000<br>fast packet</th> <th style="text-align:center;">SAE J1939-21</th> <th style="text-align:center;">RV-C</th></tr></thead> <tbody><tr><td>Number of data bytes</td> <td style="text-align:center;">0..4095</td> <td style="text-align:center;">0..223</td> <td style="text-align:center;">9..1785</td> <td style="text-align:center;">9..1785</td></tr> <tr><td>Flow control</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">no</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">no</td></tr> <tr><td>Efficient single frame</td> <td style="text-align:center;">yes</td> <td style="text-align:center;">no</td> <td style="text-align:center;">no</td> <td style="text-align:center;">no</td></tr> <tr><td>Open standard</td> <td style="text-align:center;">no</td> <td style="text-align:center;">no</td> <td style="text-align:center;">no</td> <td style="text-align:center;">yes</td></tr></tbody></table> <h2 id="data-object-publication-message"><a href="#data-object-publication-message" class="header-anchor">#</a> Data object publication message</h2> <h3 id="can-identifier-layout-3"><a href="#can-identifier-layout-3" class="header-anchor">#</a> CAN identifier layout</h3> <p>Publication messages are not sent to a single node, so the destination address does not need to be specified. So, instead of the function ID byte and the destination address byte, the data object ID is specified in the CAN identifier to have more bytes available for payload in the data bytes.</p> <p><img src="/thingset/branch/quickfix-example-4/assets/img/publication_msg_can_id.7c0c857a.png" alt="CAN data object publication message ID"></p> <ul><li>Priority (28-26): Defines the importance of the message. For data object publication messages, only 4 (high priority), 5 (medium priority) and 6 (low priority) are valid.</li> <li>Extended data page / EDP (25): Always 1b to prevent collision with SAE J1939 and NMEA2000 devices on the same bus</li> <li>Message type (24): 1b for data object publication message</li> <li>Data object ID (23-8): Data object ID of application layer protocol which is published. The most significant byte of this 16-bit ID is stored first (bits 23 to 16).</li> <li>Source address (7-0): Source node address (255 for anonymous message during address claiming)</li></ul> <h3 id="can-data-format"><a href="#can-data-format" class="header-anchor">#</a> CAN data format</h3> <h4 id="data-type-and-content"><a href="#data-type-and-content" class="header-anchor">#</a> Data type and content</h4> <p>The first byte of the payload defines the data type of the published data object. The data type is encoded using a 6-bit unsigned integer. The first two bits of the byte can be used for other purposes (see below).</p> <p>The following data types are defined:</p> <table><thead><tr><th>6-bit typeID</th> <th>CBOR type</th> <th>CBOR description</th></tr></thead> <tbody><tr><td>0x00</td> <td>0x18</td> <td>Unsigned integer (one-byte uint8_t follows)</td></tr> <tr><td>0x01</td> <td>0x19</td> <td>Unsigned integer (two-byte uint16_t follows)</td></tr> <tr><td>0x02</td> <td>0x1a</td> <td>Unsigned integer (four-byte uint32_t follows)</td></tr> <tr><td>0x03</td> <td>0x1b</td> <td>Unsigned integer (eight-byte uint64_t follows)</td></tr> <tr><td>0x04</td> <td>0x38</td> <td>Negative integer -1-n (one-byte uint8_t for n follows)</td></tr> <tr><td>0x05</td> <td>0x39</td> <td>Negative integer -1-n (two-byte uint16_t for n follows)</td></tr> <tr><td>0x06</td> <td>0x3a</td> <td>Negative integer -1-n (four-byte uint32_t for n follows)</td></tr> <tr><td>0x07</td> <td>0x3b</td> <td>Negative integer -1-n (eight-byte uint64_t for n follows)</td></tr> <tr><td>0x08</td> <td>0x58</td> <td>byte string (one-byte uint8_t for n, and then n bytes follow)</td></tr> <tr><td>0x0C</td> <td>0x78</td> <td>UTF-8 string (one-byte uint8_t for n, and then n bytes follow)</td></tr> <tr><td>0x10</td> <td>0x98</td> <td>array (one-byte uint8_t for n, and then n data items follow)</td></tr> <tr><td>0x14</td> <td>0xb8</td> <td>map (one-byte uint8_t for n, and then n pairs fo data items follow)</td></tr> <tr><td>0x1E</td> <td>0xfa</td> <td>Single-Precision Float (four-byte IEEE 754)</td></tr> <tr><td>0x1F</td> <td>0xfb</td> <td>Double-Precision Float (eight-byte IEEE 754)</td></tr> <tr><td>0x20</td> <td>0xc0</td> <td>Text-based date/time (data item follows; see section 2.4.1</td></tr> <tr><td>0x21</td> <td>0xc1</td> <td>Epoch-based date/time (data item follows; see section 2.4.1</td></tr> <tr><td>0x24</td> <td>0xc4</td> <td>Decimal Fraction (data item &quot;array&quot; follows; see Section 2.4.3</td></tr> <tr><td>0x3C</td> <td>0xf4</td> <td>False</td></tr> <tr><td>0x3D</td> <td>0xf5</td> <td>True</td></tr> <tr><td>0x3E</td> <td>0xf6</td> <td>Null</td></tr> <tr><td>0x3F</td> <td>0xf7</td> <td>Undefined</td></tr></tbody></table> <p>The data type is compatible with the CBOR format used in the ThingSet application layer protocol. The 6-bit data type ID can be converted to a valid CBOR first byte using simple bit-shift operations.</p> <p>Assuming the data of the CAN frame is stored in an array data[0...7], use the following operation to generate valid CBOR data for type ID &lt; 0x20 (stored in data[0]) :</p> <div class="language- extra-class"><pre class="language-text"><code>data[0] = (data[0] &amp; 0x1C) &lt;&lt; 3 + (data[0] &amp; 0x03) + 0x18
</code></pre></div><p>For data type ID &gt;= 0x20 (stored in data[0]) the bit shifting operation is slightly different:</p> <div class="language- extra-class"><pre class="language-text"><code>data[0] = (data[0] &amp; 0x18) &lt;&lt; 1 + (data[0] &amp; 0x07) + 0xC0
</code></pre></div><p>Of course, you can also store a map of the above table and replace the 6-bit typeID by the CBOR type. However, the bit-shift operations will be more efficient.</p> <p>Using above method, the generated CBOR might not be the most compact form, as the values stored directly in the first byte (e.g. 0..23) are not used. However, the generated data is still valid CBOR.</p> <h4 id="time-stamp"><a href="#time-stamp" class="header-anchor">#</a> Time stamp</h4> <p>In order to acquire real-time measurement values, a 16-bit timestamp (unsigned int) can be appended to the data content bytes. The timestamp contains the 16 least significant bits of the microcontroller's system clock in milliseconds. It is a rolling counter and restarts at 0 after an overflow. The timestamp cannot be used to determine the absolute time of a measurement, but the time difference between subsequent measurements. This is important to obtain correct sampling of time-series data if higher priority messages cause a delay of the data delivery on the bus.</p> <p>The second bit of the first byte defines if the time stamp is present or not (see below).</p> <h4 id="tiny-transport-protocol-tiny-tp-for-message-broadcasting"><a href="#tiny-transport-protocol-tiny-tp-for-message-broadcasting" class="header-anchor">#</a> Tiny transport protocol (Tiny-TP) for message broadcasting</h4> <p>The transport protocol for the data object publication messages is much more simple and lightweight than the ISO-TP used for the service messages described above.</p> <p>It fulfills the following requirements:</p> <ul><li>Minimum overhead for single-frame messages</li> <li>No flow control</li> <li>Comparably low maximum data length to allow small buffer sizes</li></ul> <p>The Tiny-TP adds a header of 1 byte to each message with the following format:</p> <ul><li>bit 7: multi-frame message</li> <li>bit 6: last frame</li> <li>bits 5-4: sequence identifier (2-bit unsigned integer)</li> <li>bits 3-0: frame count (4-bit unsigned integer)</li></ul> <p>For a multi-frame message, bit 7 is set to 1, for a single-frame message to 0. In case of a single-frame message, the remaining 7 bits of the Tiny-TP header might be used as payload data.</p> <p>The last frame is identified with bit 6 set to 1. For all other multi-frame packets it must be set to 0.</p> <p>In order to distinguish different messages with the same CAN ID, bits 5-4 contain a sequence identifier which is incremented each time a multi-packet message transfer for the same CAN ID (i.e. data object ID) is started.</p> <p>The last four bits (3-0) contain a frame counter. The first frame of a multi-frame message starts with the frame counter set to 0. A maximum total number of 16 multi-frame messages is possible, resulting in a maximum of 2^4*7 = 112 bytes maximum message length.</p> <p>Compared to NMEA 2000 fast-packet, the Tiny-TP format reduces the overhead of single-frame messages from two bytes to as low as 1 bit.</p> <h4 id="single-frame-data-publication-message"><a href="#single-frame-data-publication-message" class="header-anchor">#</a> Single-frame data publication message</h4> <p>A single-frame message uses only the first bit of the Tiny-TP. The remaining bits of the first byte are used for a timestamp flag and the data type, thus using the 8 CAN data bytes very efficiently.</p> <p><img src="/thingset/branch/quickfix-example-4/assets/img/pub_msg_single.533953b6.png" alt="CAN data object publication message ID"></p> <ul><li>Multi-frame message flag: 0b (single-frame message)</li> <li>Timestamp flag: 1b if timestamp will be sent, otherwise 0b</li> <li>Data type: 6-bit unsigned int (see application protocol)</li> <li>Data / Timestamp bytes: data bytes depending on data type, 16-bit timestamp appended if timestamp flag set.</li></ul> <h4 id="multi-frame-data-publication-message"><a href="#multi-frame-data-publication-message" class="header-anchor">#</a> Multi-frame data publication message</h4> <p>Multi-frame messages need the entire first byte for the Tiny-TP header information. The timestamp flag and the data type are moved to the second byte, followed by the data content and timestamp (if enabled).</p> <p><img src="/thingset/branch/quickfix-example-4/assets/img/pub_msg_multi_first.31050ca4.png" alt="CAN data object publication message ID"></p> <ul><li>Multi-frame message flag: 1b</li> <li>Last frame flag: 0b</li> <li>Sequence identifier: 0-3 (incremented for each start of multi-packet message transmission for given CAN ID)</li> <li>Frame count: 0 (first frame)</li> <li>Timestamp flag: 1b if timestamp will be sent, otherwise 0b</li> <li>Data type: 6-bit unsigned int (see application protocol)</li> <li>Data / Timestamp bytes: data bytes depending on data type, 16-bit timestamp appended if timestamp flag set.</li></ul> <p>Consecutive messages also contain the Tiny-TP header, directly followed by the data / timestamp bytes.</p> <p><img src="/thingset/branch/quickfix-example-4/assets/img/pub_msg_multi_consecutive.9036b9ff.png" alt="CAN data object publication message ID"></p> <ul><li>Multi-frame message flag: 1b</li> <li>Last frame flag: 1b if last frame, otherwise 0b</li> <li>Sequence identifier: 0-3 (see above)</li> <li>Frame count: 0-15</li> <li>Data / Timestamp bytes: data bytes depending on data type, 16-bit timestamp appended if timestamp flag set.</li></ul> <h1 id="can-physical-layer"><a href="#can-physical-layer" class="header-anchor">#</a> CAN Physical layer</h1> <p>ToDo:</p> <ul><li>RJ45 connector using CANopen pinout</li> <li>Bus Power supply</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/13/2020, 9:22:38 AM</span></div></footer> <!---->  <div class="footer">
    Content provided by <a href="https://libre.solar">Libre Solar</a> under <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC-BY-SA 4.0 License</a> | <a href="https://libre.solar/about/contact/">Contact / Impressum</a></div></main></div><div class="global-ui"></div></div>
    <script src="/thingset/branch/quickfix-example-4/assets/js/app.e82a7297.js" defer></script><script src="/thingset/branch/quickfix-example-4/assets/js/2.f8dcb625.js" defer></script><script src="/thingset/branch/quickfix-example-4/assets/js/3.37d47788.js" defer></script><script src="/thingset/branch/quickfix-example-4/assets/js/4.6408cc72.js" defer></script>
  </body>
</html>
